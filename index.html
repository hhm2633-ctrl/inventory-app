<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>솔리드옴므 아울렛재고조회</title>

<meta name="theme-color" content="#0b0f14" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="icon" sizes="192x192" href="icons/icon-192.png" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<style>
  :root { --bg:#0b0f14; --card:#121820; --muted:#7a8593; --fg:#e8eef6; --accent:#5bbcff; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; }
  header { padding:16px 20px; border-bottom:1px solid #1c2430; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  header h1 { margin:0; font-size:18px; }
  .pill { background:#0f1620; border:1px solid #233042; padding:6px 10px; border-radius:100px; color:var(--muted); }
  .container { padding:16px; display:grid; gap:16px; max-width:980px; margin:0 auto; }
  .card { background:var(--card); border:1px solid #1c2430; border-radius:14px; padding:14px; }
  .card h2 { margin:0 0 10px 0; font-size:16px; }
  .hint { color:var(--muted); font-size:12px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .search { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #273547; background:#0f1620; color:var(--fg); }
  .btn { background:linear-gradient(180deg,#1c2735,#151e2a); border:1px solid #273547; color:#d9e7ff; padding:8px 12px; border-radius:10px; cursor:pointer; text-decoration:none; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }
  .badge { display:inline-block; padding:4px 8px; border-radius:9px; font-size:12px; border:1px solid #2a3950; color:#cfe8ff; }
  .ok { background:#12321f; border-color:#1f5c37; color:#c6ffdf; }
  .warn { background:#33240f; border-color:#6b4b17; color:#ffe1b8; }
  .incoming { background:#1e2240; border-color:#3d4aac; color:#d2d8ff; }
  .product { display:grid; gap:12px; border:1px solid #1c2430; border-radius:12px; padding:12px; }
  .product-head { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .title { font-size:15px; font-weight:600; }
  .code { color:#a6b3c4; font-family:ui-monospace,Menlo,Consolas,monospace; }
  .controls { display:flex; gap:8px; align-items:center; }
  .select { padding:8px 10px; border-radius:10px; border:1px solid #273547; background:#0f1620; color:var(--fg); }
  .sizes { display:grid; gap:6px; }
  .size-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid #223044; border-radius:10px; background:#0f1620; }
  .size-left { display:flex; gap:10px; align-items:center; }
  .size-chip { min-width:40px; text-align:center; border:1px solid #314257; border-radius:8px; padding:4px 8px; color:#dfe9ff; }
  .price { color:#cfe1ff; font-size:12px; }
  .ads { background:#0f1620; border:1px dashed #243349; border-radius:12px; padding:14px; color:#9eb0c8; text-align:center; }
</style>
</head>
<body>
  <header>
    <h1>솔리드옴므 아울렛 재고 조회</h1>
    <span class="pill">매장전화연결 카카오채널연결</span>
  </header>

  <div class="container">
    <div class="card">
      <h2>검색</h2>
      <div class="row">
        <input id="q" class="search" placeholder="예: s243ts26, 로고 티셔츠…" />
        <button id="installBtn" class="btn" style="display:none;">앱 설치</button>
      </div>
      <div style="height:6px"></div>
      <div class="hint">동일 품번을 하나로 묶어서 보여주고, <b>컬러는 선택</b>, <b>사이즈는 세로 목록</b>으로 상태만 표시합니다.</div>
    </div>

    <div class="card">
      <h2>재고 결과</h2>
      <div id="results" class="grid" style="display:grid; gap:12px;"></div>
      <div id="nores" class="hint" style="display:none;">검색 결과가 없습니다.</div>
      <div style="height:10px"></div>
      <div class="hint">※ “주문” 버튼은 Google Forms로 이동하며, 상품정보가 자동으로 채워집니다.</div>
    </div>

    <!-- 선택 사항: 여백에 광고영역(나중에 AdSense 승인/스크립트 붙이면 노출됨) -->
    <div class="card">
      <div class="ads" id="ad-placeholder">
        [광고 영역] 커스텀 도메인 연결 + AdSense 승인 후 스크립트를 여기에 붙이면 노출됩니다.
      </div>
    </div>
  </div>

<script>
/* ===== 설정(여기만 바꾸세요): 구글폼 ===== */
const GOOGLE_FORM_BASE = "https://docs.google.com/forms/d/e/FORM_ID/viewform";
const FORM_ENTRY = {
  상품코드: "entry.1111111111",
  품명:    "entry.2222222222",
  색상:    "entry.3333333333",
  사이즈:  "entry.4444444444",
  수량:    "entry.5555555555"
};

/* ===== 데이터 URL ===== */
const JSON_URL = "./inventory.json";

/* ===== 유틸 ===== */
const nz = (v)=> (v==null?"":String(v).trim());
function badgeClass(st){
  if (st==="주문가능") return "badge ok";
  if (nz(st).startsWith("입고 예정")) return "badge incoming";
  if (st==="품절임박") return "badge warn";
  return "badge";
}
function buildOrderLink(row){
  const p = new URL(GOOGLE_FORM_BASE);
  p.searchParams.set("usp","pp_url");
  p.searchParams.set(FORM_ENTRY.상품코드, nz(row["상품코드"]));
  p.searchParams.set(FORM_ENTRY.품명, nz(row["품명"]));
  p.searchParams.set(FORM_ENTRY.색상, nz(row["색상"]));
  p.searchParams.set(FORM_ENTRY.사이즈, nz(row["사이즈"]));
  p.searchParams.set(FORM_ENTRY.수량, "1");
  return p.toString();
}

/* ===== 전역 ===== */
let ALL_ROWS = [];
let GROUPS = []; // [{code,name,colors:[{color, items:[rows]}]}]
let VIEW_LIST = []; // 검색 결과: code 단위

/* ===== 데이터 로딩 ===== */
async function loadData(){
  try{
    const res = await fetch(JSON_URL, {cache:"no-store"});
    const data = await res.json();
    ALL_ROWS = Array.isArray(data.rows)? data.rows: [];
  }catch(e){
    try{
      const res = await fetch(JSON_URL);
      const data = await res.json();
      ALL_ROWS = Array.isArray(data.rows)? data.rows: [];
    }catch(e2){
      ALL_ROWS = [];
    }
  }
  buildGroups();
  applySearch("");
}

function buildGroups(){
  const byCode = new Map();
  for(const r of ALL_ROWS){
    const code = nz(r["상품코드"]); if(!code) continue;
    const name = nz(r["품명"]);
    const color = nz(r["색상"]);
    const size  = nz(r["사이즈"]);
    if(!byCode.has(code)){
      byCode.set(code, { code, name, colors:new Map() });
    }
    const bucket = byCode.get(code);
    if(!bucket.colors.has(color)) bucket.colors.set(color, []);
    bucket.colors.get(color).push(r);
  }
  GROUPS = Array.from(byCode.values()).map(g=>{
    // 색상/사이즈 정렬
    const colors = Array.from(g.colors.entries()).map(([color, items])=>{
      items = items.slice().sort((a,b)=>{
        // 사이즈 숫자/문자 혼용 정렬
        const av = nz(a["사이즈"]), bv = nz(b["사이즈"]);
        const ai = parseInt(av,10), bi = parseInt(bv,10);
        if(!isNaN(ai) && !isNaN(bi) && ai!==bi) return ai-bi;
        return av.localeCompare(bv);
      });
      return { color, items };
    }).sort((a,b)=> a.color.localeCompare(b.color));
    return { code:g.code, name:g.name, colors };
  });
}

/* ===== 렌더 ===== */
function render(){
  const root = document.getElementById("results");
  const empty = document.getElementById("nores");
  root.innerHTML = "";
  if(!VIEW_LIST.length){ empty.style.display="block"; return; }
  empty.style.display="none";

  for(const prod of VIEW_LIST){
    const wrap = document.createElement("div");
    wrap.className = "product";

    const head = document.createElement("div");
    head.className = "product-head";

    const left = document.createElement("div");
    left.innerHTML = `<div class="title">${nz(prod.name)||nz(prod.code)}</div>
                      <div class="code">${nz(prod.code)}</div>`;

    const right = document.createElement("div");
    right.className = "controls";
    const sel = document.createElement("select");
    sel.className = "select";
    for(const c of prod.colors){
      const opt = document.createElement("option");
      opt.value = c.color; opt.textContent = c.color || "(색상없음)";
      sel.appendChild(opt);
    }
    right.appendChild(sel);

    head.appendChild(left);
    head.appendChild(right);
    wrap.appendChild(head);

    const sizes = document.createElement("div");
    sizes.className = "sizes";
    wrap.appendChild(sizes);

    function drawSizes(colorValue){
      sizes.innerHTML = "";
      const colorBucket = prod.colors.find(c=> c.color===colorValue) || prod.colors[0];
      for(const r of (colorBucket?.items||[])){
        const line = document.createElement("div");
        line.className = "size-row";

        const left = document.createElement("div");
        left.className = "size-left";
        const sizeChip = document.createElement("div");
        sizeChip.className = "size-chip";
        sizeChip.textContent = nz(r["사이즈"])||"-";
        const badge = document.createElement("span");
        badge.className = badgeClass(nz(r["상태"]));
        badge.textContent = nz(r["상태"]);
        left.appendChild(sizeChip);
        left.appendChild(badge);

        const order = document.createElement("a");
        order.className = "btn";
        order.target = "_blank"; order.rel = "noopener";
        order.textContent = "주문";
        order.href = buildOrderLink({
          "상품코드": r["상품코드"],
          "품명": r["품명"],
          "색상": colorBucket?.color || r["색상"],
          "사이즈": r["사이즈"]
        });

        line.appendChild(left);
        line.appendChild(order);
        sizes.appendChild(line);
      }
    }

    sel.addEventListener("change", (e)=> drawSizes(e.target.value));
    drawSizes(sel.value || (prod.colors[0]?.color ?? ""));
    root.appendChild(wrap);
  }
}

function applySearch(q){
  const qq = nz(q).toLowerCase();
  if(!qq){
    VIEW_LIST = GROUPS.slice(0,200); // 너무 많을 때 대비
  }else{
    VIEW_LIST = GROUPS.filter(g=>{
      const code = nz(g.code).toLowerCase();
      const name = nz(g.name).toLowerCase();
      return code.includes(qq) || name.includes(qq);
    }).slice(0,200);
  }
  render();
}

/* ===== 이벤트 ===== */
document.getElementById("q").addEventListener("input", (e)=> applySearch(e.target.value));

/* ===== PWA 설치 버튼 ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try { await navigator.serviceWorker.register("./service-worker.js"); } catch(e){}
  });
}
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt", (e)=>{ e.preventDefault(); deferredPrompt=e; const b=document.getElementById("installBtn"); if(b) b.style.display="inline-block"; });
document.getElementById("installBtn")?.addEventListener("click", async ()=>{
  if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; document.getElementById("installBtn").style.display="none";
});

/* 시작 */
loadData();
</script>
</body>
</html>
