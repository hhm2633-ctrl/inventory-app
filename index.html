<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>솔리드옴므 아울렛 재고 조회</title>
<link rel="manifest" href="manifest.webmanifest?v=12" />
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<style>
  :root { --bg:#0b0f14; --card:#121820; --muted:#94a3b8; --fg:#e8eef6; --accent:#5bbcff;
          --ok:#16a34a; --warn:#d97706; --bad:#ef4444; --incoming:#3b82f6; }
  html,body{margin:0;padding:0;background:#0b0f14;color:var(--fg);
            font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px;}
  h1{margin:0 0 16px 0;font-size:24px;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:#111827;border:1px solid #273547;color:#d9e7ff;padding:9px 12px;border-radius:12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .btn.big{padding:10px 14px;font-weight:700}
  .btn.primary{background:#0f172a;border-color:#2b3a52}
  .btn.green{background:#0f2b1b;border-color:#1f5c37}
  .btn.blue{background:#0f1a3a;border-color:#3d4aac}
  .btn.ghost{background:transparent;border-color:#2b3a52}
  .search{width:100%;padding:12px 14px;border-radius:14px;border:1px solid #273547;background:#0f1620;color:var(--fg);font-size:16px;}
  .card{background:linear-gradient(180deg,#121820,#0d1420);border:1px solid #1c2430;border-radius:16px;padding:16px;}
  .pill{border:1px solid #2a3950;background:#0f172a;color:#cfe8ff;border-radius:999px;padding:5px 9px;font-size:12px}
  .state{display:inline-block;border-radius:16px;padding:6px 12px;font-size:13px;border:1px solid transparent;
         cursor:pointer; background:#0f172a; color:#cfe8ff}
  .state.ok{background:#0f2b1b;border-color:#1f5c37;color:#b9f7d5}
  .state.warn{background:#2c1e0a;border-color:#7a4d17;color:#ffe4b5}
  .state.bad{background:#3a0f14;border-color:#7a1d22;color:#ffc9c9; cursor:default}
  .state.incoming{background:#0f1a3a;border-color:#3d4aac;color:#d2d8ff; cursor:default}
  .state:disabled{opacity:.6;cursor:not-allowed}
  .sizeCol{display:flex;flex-direction:column;gap:8px}
  .sizeItem{display:flex;align-items:center;gap:10px}
  .sizeTag{min-width:44px;text-align:center;border:1px solid #2a3950;border-radius:10px;padding:6px 8px;background:#0e1726;color:#cfe8ff;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 210px 1fr;gap:10px;align-items:center}
  .select{padding:9px 12px;border-radius:10px;border:1px solid #273547;background:#0e1622;color:var(--fg)}
  .price{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .price .now{font-weight:800;font-size:17px}
  .price .orig{color:#a8b5c6;text-decoration:line-through}
  .price .rate{color:#9fe4b0}
  .totalBox{margin-top:8px;border:1px dashed #2e3c52;border-radius:12px;padding:8px 10px;background:#0f172a}
  .totalBox .line{display:flex;justify-content:space-between;margin:2px 0}
  .totalBox .sum{font-weight:800}
  .hint{font-size:12px;color:#a5b4c6}
  footer{margin:24px 0;color:#9aa7b8;font-size:13px;display:flex;gap:14px;flex-wrap:wrap;justify-content:flex-end}
  .hero{position:fixed;inset:0;z-index:-1;background:url('031.jpg') center/cover no-repeat;filter:brightness(.35)}
  .status{margin:0 0 10px 0;padding:10px;border-radius:10px;background:#1a2432;border:1px solid #29364a;color:#cde1ff}
  .status b{color:#fff}
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999;padding:10px}
  .modal{width:min(560px,94vw);max-height:88vh;display:flex;flex-direction:column;background:#101622;border:1px solid #1e2a3a;border-radius:16px;}
  .modalHeader{padding:14px 16px;border-bottom:1px solid #1c2430;display:flex;align-items:center;justify-content:space-between}
  .modalBody{padding:14px 16px;overflow:auto}
  .modalFooter{padding:12px 16px;border-top:1px solid #1c2430;display:flex;justify-content:flex-end;gap:8px}
  .muted{color:#a1a8b5}
  .copy{border:1px dashed #2e3c52;border-radius:10px;padding:8px 10px;background:#0f172a}
  .note{background:#0e1522;border:1px solid #203047;border-radius:12px;padding:10px}
  .small{font-size:12px;color:#9fb0c6}
  input.txt, textarea.txt, select.sel{width:100%;padding:9px 11px;border-radius:10px;border:1px solid #2a3950;background:#0f172a;color:#e7f0ff;font-size:14px}
  textarea.txt{min-height:64px;resize:vertical}
  .label{font-size:12px;color:#9fb0c6;margin:6px 0 4px}
  .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .buttonRow{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:520px){ .grid{grid-template-columns:1fr;gap:8px} }
  .icon{font-size:16px}
</style>
</head>
<body>
<div class="hero"></div>
<div class="wrap">

  <!-- 상태/안내 -->
  <div id="status" class="status" style="display:none"></div>

  <!-- 상단 액션 -->
  <div class="row" style="justify-content:flex-end;gap:8px;margin-bottom:6px">
    <a class="btn" href="tel:0221369886" aria-label="매장 전화 연결"><span class="icon">📞</span>매장 전화</a>
    <a class="btn" href="https://pf.kakao.com/_EfjEj/chat" target="_blank" rel="noopener" aria-label="카카오 채널 연결"><span class="icon">💬</span>카카오 채널</a>
    <button class="btn" id="reloadBtn" title="데이터 새로고침"><span class="icon">🔄</span>새로고침</button>
  </div>

  <h1>솔리드옴므 아울렛 재고 조회</h1>

  <div class="card" style="margin-bottom:12px">
    <div class="row" style="gap:8px">
      <input id="q" class="search" placeholder="예: s243ts26…" />
      <button class="btn" id="srchBtn"><span class="icon">🔎</span>검색</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0">재고 결과</h3>
    <div id="result"></div>
  </div>

  <footer>
    <a href="about.html">브랜드 소개</a>
    <a href="privacy.html">개인정보처리방침</a>
    <a href="guide.html">주문·배송·교환 안내</a>
    <a href="tel:0221369886">📞 전화</a>
    <a href="https://pf.kakao.com/_EfjEj/chat" target="_blank" rel="noopener">💬 카카오</a>
  </footer>
</div>

<!-- 주문 모달 (생략: 기존과 동일) -->
<!-- ====== 주문/모달 영역은 이전 메시지의 것과 동일하므로 그대로 유지 ====== -->
<!-- 공간상, 아래 JS에서만 참고하는 요소 id들(#orderBack 등)은 그대로 사용됩니다. -->

<div id="orderBack" class="modalBack" onclick="closeOrder(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3 style="margin:0;font-size:18px">🧾 주문서 작성</h3>
      <button class="btn ghost" onclick="closeOrder()">닫기</button>
    </div>
    <div class="modalBody">
      <div id="orderSel" class="muted" style="margin-bottom:8px"></div>
      <div class="note small" style="margin:6px 0 10px 0">
        <div>• <b>택배비</b> : <b>40만원 이상 무료</b> / 그 이하는 <b>3,000원</b></div>
        <div>• <b>교환/반품</b> : 수령 후 7일 이내 (왕복 <b>7,000원</b>)</div>
        <div>• 오프라인 재고 연동이라 결제 후 품절 시 <b>전액 환불</b>됩니다.</div>
      </div>
      <div class="buttonRow" style="margin-bottom:6px">
        <button class="btn big green" onclick="choosePay('계좌이체')"><span class="icon">🏦</span>계좌이체로 주문</button>
        <button class="btn big blue" onclick="choosePay('카드결제')"><span class="icon">💳</span>카드결제로 주문</button>
      </div>
      <div class="formGrid" style="margin:6px 0 6px 0">
        <div><div class="label">선택된 결제 방식</div><input id="payMethod" class="txt" value="계좌이체" readonly /></div>
        <div><div class="label">수량</div><input id="qty" type="number" class="txt" min="1" step="1" value="1" /></div>
      </div>
      <div id="depositorBox"><div class="label">입금자 성명 (계좌이체)</div><input id="depositor" class="txt" placeholder="예: 홍길동" /></div>
      <div id="totalBox" class="totalBox" style="margin-top:8px">
        <div class="line"><span>단가</span><span id="unitPrice">-</span></div>
        <div class="line"><span>수량</span><span id="qtyView">1</span></div>
        <div class="line"><span>소계</span><span id="subtotalView">-</span></div>
        <div class="line"><span>배송비</span><span id="shipView">-</span></div>
        <div class="line sum"><span id="totalLabel">결제금액</span><span id="totalView">-</span></div>
        <div class="hint" id="shipHint" style="margin-top:4px"></div>
      </div>
      <div class="formGrid" style="margin-top:8px">
        <div><div class="label">수령자 이름</div><input id="recvName" class="txt" placeholder="예: 김솔리드" /></div>
        <div><div class="label">연락처</div><input id="recvPhone" class="txt" placeholder="예: 010-1234-5678" /></div>
      </div>
      <div class="label" style="margin-top:6px">주소</div>
      <div class="row" style="gap:6px;margin-bottom:6px">
        <input id="zip" class="txt" placeholder="우편번호" style="max-width:140px" readonly />
        <button class="btn" type="button" onclick="findAddr()"><span class="icon">🗺️</span>주소 검색</button>
      </div>
      <input id="road" class="txt" placeholder="도로명 주소" readonly style="margin-bottom:6px" />
      <input id="addrDetail" class="txt" placeholder="상세 주소 (동/호수 등)" />
      <div class="label" style="margin-top:6px">요청사항</div>
      <textarea id="recvNote" class="txt" placeholder="배송 관련 메모"></textarea>
      <div class="copy" style="margin-top:8px">
        <div><b>📋 주문 미리보기</b> (카카오 채널로 전송 안내)</div>
        <pre id="orderPreview" style="white-space:pre-wrap;margin:6px 0 0 0"></pre>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn primary" onclick="sendOrder()"><span class="icon">📤</span>주문 보내기</button>
      <button class="btn" onclick="shareToKakao()"><span class="icon">💬</span>카카오로 열기</button>
    </div>
  </div>
</div>

<div id="pendingBack" class="modalBack" onclick="closePending(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3 style="margin:0;font-size:18px">⏳ 주문 확인중</h3>
      <button class="btn ghost" onclick="closePending()">확인</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="white-space:pre-wrap">
영업시간 10:30~21:00 실시간 매장확인 연락드리며
영업시간 이후 21:00~ 다음날 매장 오픈 이후 순차적으로 연락드립니다.
결제/이체 확인 후 순차적으로 연락드리겠습니다. 카카오 채널 알림을 확인해 주세요.

택배비 안내 40만원 이상 구매시 무료배송 / 그 이하 3,000원 
단순 변심 교환 왕복 택배비 7,000원
국민 616 701 01 634455 솔리드(한홍명)

제품 수령 후 교환은 1주일 이내로 가능합니다.
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 상수 & 유틸 ===== */
const KAKAO_CHAT = 'https://pf.kakao.com/_EfjEj/chat';
const FREE_SHIP_THRESHOLD = 400000;
const SHIP_FEE = 3000;

const $  = s => document.querySelector(s);
const nz = v => (v==null ? '' : String(v).trim());
function toInt(v, d=0){ try{ const s=String(v??'').replace(/[^\d-]/g,'').trim(); if(!s||s==='-')return d; return parseInt(s,10);}catch{return d;} }
function fmtWon(v){ return (v==null||v==='') ? '-' : Number(v).toLocaleString()+'원'; }

function showStatus(msg, ok=false){
  const box = $('#status');
  box.style.display = 'block';
  box.innerHTML = (ok ? '✅ ' : '⚠️ ') + msg +
    (ok ? '' : `<div style="margin-top:6px;font-size:13px;color:#bcd6ff">
      • inventory.json 파일이 index.html과 같은 폴더에 있나요?<br/>
      • 또는 data/inventory.json 경로로 올려보셨나요?<br/>
      • 파일명이 "inventory (1).json" 같이 공백/괄호가 들어가면 안 됩니다.
    </div>`);
}

/* ===== 데이터 로더 (강화) ===== */
let INV=[];
async function loadInventory(){
  const candidates = [
    `inventory.json?v=${Date.now()}`,
    `inventory.json`,
    `data/inventory.json?v=${Date.now()}`,
    `data/inventory.json`
  ];
  let lastErr = '';
  for (const url of candidates){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) { lastErr = `${url} -> HTTP ${res.status}`; continue; }
      const j = await res.json();
      const arr = Array.isArray(j) ? j : (Array.isArray(j.data) ? j.data : (Array.isArray(j.rows) ? j.rows : null));
      if (!arr) { lastErr = `${url} -> JSON 형식이 배열이 아님`; continue; }
      INV = arr.map(normalizeRow);
      showStatus(`데이터 로드 성공: ${url}`, true);
      return;
    }catch(e){
      lastErr = `${url} -> ${e?.message||e}`;
    }
  }
  INV = [];
  showStatus(`재고 파일을 불러오지 못했습니다. 마지막 오류: ${lastErr}`);
}

/* ===== 상태 규칙(매장 우선) ===== */
function decideState(store, wh, total){
  store=+store||0; wh=+wh||0; total=+total||0;
  if (store>=1 && wh>=1) return {label:'✅ 주문가능', cls:'ok', clickable:true};
  if (store==0 && wh>=1) return {label:'📦 주문불가(미입고)', cls:'incoming', clickable:false};
  if (total<=9)           return {label:'⏳ 품절임박', cls:'warn', clickable:true};
  if (store>=1)           return {label:'✅ 주문가능', cls:'ok', clickable:true};
  if (store==0 && wh==0)  return {label:'❌ 주문불가', cls:'bad', clickable:false};
  return {label:'✅ 주문가능', cls:'ok', clickable:true};
}

function normalizeRow(r){
  const out = {...r};
  if (out['매장재고']==null && out['매장합']!=null) out['매장재고']=out['매장합'];
  if (out['창고재고']==null && out['물류합']!=null) out['창고재고']=out['물류합'];
  if (out['전체재고']==null && out['전체합']!=null) out['전체재고']=out['전체합'];
  if (out['소비자가']==null && out['할인전가격']!=null) out['소비자가']=out['할인전가격'];
  if (out['할인율']==null && out['할인율(%)']!=null) out['할인율']=out['할인율(%)'];
  return out;
}

/* ===== 그룹핑/정렬/가격 ===== */
function groupByStyle(rows){
  const map = new Map();
  for (const r of rows){
    const code = nz(r['상품코드']).toUpperCase();
    const color = nz(r['색상']);
    const size  = nz(r['사이즈']);
    if (!map.has(code)) map.set(code, {code, colors:new Map()});
    const entry = map.get(code);
    if (!entry.colors.has(color)) entry.colors.set(color, []);
    entry.colors.get(color).push(r);
  }
  const orderRTW=['44','46','48','50','52','54'];
  const orderP=['28','30','31','32','33','34','36'];
  const orderS=['39','40','41','42','43'];
  const idx=(s)=> orderRTW.includes(s)?orderRTW.indexOf(s):orderP.includes(s)?100+orderP.indexOf(s):orderS.includes(s)?200+orderS.indexOf(s):999;
  for (const [,v] of map){ for (const [c,arr] of v.colors){ arr.sort((a,b)=>idx(nz(a['사이즈']))-idx(nz(b['사이즈']))); v.colors.set(c,arr);} }
  return map;
}
function computePrice(rows){
  const r0 = rows.find(r=> r['판매가']!=null || r['소비자가']!=null || r['할인율']!=null) || {};
  let p = toInt(r0['판매가'], null);
  let q = toInt(r0['소비자가'], null);
  let r = r0['할인율']!=null ? Number(r0['할인율']) : null;
  if ((r==null || Number.isNaN(r)) && p!=null && q!=null && q>0) r = Math.round((1 - p/q) * 1000)/10;
  if ((q==null || q===0) && p!=null && r!=null) q = Math.round(p / (1 - r/100));
  return {p,q,r};
}
function priceHTML(rows){
  const {p,q,r} = computePrice(rows);
  if (p==null && q==null) return `<div class="pill">가격 정보 없음</div>`;
  const a=[];
  if (q!=null) a.push(`<span class="orig">정가 ${fmtWon(q)}</span>`);
  if (p!=null) a.push(`<span class="now">판매가 ${fmtWon(p)}</span>`);
  if (r!=null) a.push(`<span class="rate">(-${r}%)</span>`);
  return `<div class="price">${a.join(' ')}</div>`;
}

/* ===== 결제 총액 계산/표시 ===== */
function calcTotals(price, qty, pay){
  const unit = (price.p!=null ? price.p : price.q);
  const unitSafe = (unit==null ? 0 : unit);
  const subtotal = unitSafe * qty;
  let shipFee = 0, total = subtotal, hint = '';
  if (subtotal >= FREE_SHIP_THRESHOLD){
    hint = '🚚 40만원 이상 무료배송';
  }else{
    if (pay === '계좌이체'){ shipFee = SHIP_FEE; total = subtotal + shipFee; hint = '계좌이체: 40만원 미만 배송비 3,000원 포함'; }
    else { hint = '카드결제: 40만원 미만 배송비 3,000원 별도 안내'; }
  }
  return { unit, subtotal, shipFee, total, hint };
}

/* ===== 렌더 ===== */
function renderTotals(){
  const qty = Math.max(1, parseInt($('#qty').value||'1',10));
  const method = $('#payMethod').value || '계좌이체';
  const t = calcTotals(cur.price||{}, qty, method);
  $('#unitPrice')?.replaceChildren(document.createTextNode(fmtWon(t.unit)));
  $('#qtyView')?.replaceChildren(document.createTextNode(String(qty)));
  $('#subtotalView')?.replaceChildren(document.createTextNode(fmtWon(t.subtotal)));
  $('#shipView')?.replaceChildren(document.createTextNode((method==='계좌이체' || t.subtotal>=FREE_SHIP_THRESHOLD) ? fmtWon(t.shipFee) : '추가 예정'));
  $('#totalLabel')?.replaceChildren(document.createTextNode(method==='계좌이체' ? '결제금액(계좌이체)' : '결제금액(예상)'));
  $('#totalView')?.replaceChildren(document.createTextNode(method==='계좌이체' ? fmtWon(t.total) : fmtWon(t.subtotal)));
  $('#shipHint')?.replaceChildren(document.createTextNode(t.hint));
}

function render(list){
  if (!list.length){ $('#result').innerHTML = `<div style="color:#9aa7b8">검색 결과가 없습니다.</div>`; return; }
  const g = groupByStyle(list);
  const blocks=[];
  for (const [, item] of g){
    const colors = Array.from(item.colors.keys());
    const colorSelId = 'color_'+Math.random().toString(36).slice(2,8);
    const firstColor = colors[0] || '(색상없음)';
    const firstRows  = item.colors.get(firstColor) || [];
    const head = `
      <div class="grid" style="margin:6px 0 8px 0">
        <div><div class="pill" style="font-weight:700;font-size:16px">🔖 ${item.code}</div></div>
        <div>
          <select id="${colorSelId}" class="select">
            ${colors.map(c=>`<option value="${c}">${c || '(색상없음)'}</option>`).join('')}
          </select>
        </div>
        <div id="${colorSelId}_price">${priceHTML(firstRows)}</div>
      </div>
      <div id="${colorSelId}_sizes" class="sizeCol"></div>
    `;
    blocks.push(`<div style="border-top:1px solid #1c2430;padding-top:10px;margin-top:10px">${head}</div>`);
    setTimeout(()=> {
      updateSizes(colorSelId, item, firstColor);
      const sel = document.getElementById(colorSelId);
      sel?.addEventListener('change', (e)=>{
        const c = e.target.value;
        updateSizes(colorSelId, item, c);
        document.getElementById(colorSelId+'_price').innerHTML = priceHTML(item.colors.get(c)||[]);
      });
    }, 0);
  }
  $('#result').innerHTML = blocks.join('');
}

function updateSizes(id, item, color){
  const box = document.getElementById(id+'_sizes');
  const rows = item.colors.get(color)||[];
  if (!rows.length){
    box.innerHTML = `<div class="sizeItem"><span class="sizeTag">-</span><span class="state bad">❌ 주문불가</span></div>`;
    return;
  }
  const html = rows.map(r=>{
    const size = nz(r['사이즈'])||'-';
    const st = decideState(r['매장재고'], r['창고재고'], r['전체재고']);
    const attrs = `data-style="${item.code}" data-color="${color}" data-size="${size}" data-price='${JSON.stringify(computePrice(rows))}'`;
    const clickable = st.clickable ? `onclick="openOrderDirect(this)" role="button" tabindex="0"` : 'aria-disabled="true"';
    return `<div class="sizeItem">
              <span class="sizeTag">${size}</span>
              <span class="state ${st.cls}" ${attrs} ${clickable}>${st.label}</span>
            </div>`;
  }).join('');
  box.innerHTML = html;
}

/* ===== 주소검색 ===== */
function findAddr(){
  new daum.Postcode({
    oncomplete: function(d) {
      $('#zip').value  = d.zonecode || '';
      $('#road').value = d.roadAddress || d.address || '';
      $('#addrDetail').focus();
      updatePreview();
    }
  }).open();
}

/* ===== 주문 흐름 (기존과 동일) ===== */
let cur = {style:'', color:'', size:'', price:{p:null,q:null,r:null}, pay:'계좌이체'};
function openOrderDirect(el){
  cur.style = el.getAttribute('data-style');
  cur.color = el.getAttribute('data-color');
  cur.size  = el.getAttribute('data-size');
  try { cur.price = JSON.parse(el.getAttribute('data-price')||'{}'); } catch { cur.price={}; }
  cur.pay = '계좌이체';
  const {p,q,r} = cur.price||{};
  const priceLine = [
    q!=null?`정가 ${fmtWon(q)}`:'', 
    p!=null?`판매가 ${fmtWon(p)}`:'', 
    (r!=null && !isNaN(r))?`할인율 ${r}%`:''
  ].filter(Boolean).join(' · ') || '가격 정보 없음';

  $('#orderSel').textContent = `🧾 선택: ${cur.style} ${cur.color || ''} ${cur.size || ''}  |  ${priceLine}`;
  $('#qty').value = 1;
  $('#payMethod').value = cur.pay;
  $('#depositor').value = '';
  $('#recvName').value = '';
  $('#recvPhone').value = '';
  $('#zip').value = '';
  $('#road').value = '';
  $('#addrDetail').value = '';
  $('#recvNote').value = '';
  showDepositor(true);
  renderTotals();
  updatePreview();
  $('#orderBack').style.display='flex';
}
function closeOrder(){ $('#orderBack').style.display='none'; }

function choosePay(kind){
  cur.pay = kind;
  $('#payMethod').value = kind;
  showDepositor(kind==='계좌이체');
  renderTotals();
  updatePreview();
}
function showDepositor(show){ $('#depositorBox').style.display = show ? 'block' : 'none'; }

['qty','depositor','recvName','recvPhone','addrDetail','recvNote'].forEach(id=>{
  document.addEventListener('input', (e)=>{ if (e.target && e.target.id===id) { renderTotals(); updatePreview(); } });
  document.addEventListener('change', (e)=>{ if (e.target && e.target.id===id) { renderTotals(); updatePreview(); } });
});

function buildOrderText(){
  const qty  = Math.max(1, parseInt($('#qty').value||'1',10));
  const dep  = $('#depositor').value.trim();
  const name = $('#recvName').value.trim();
  const phone= $('#recvPhone').value.trim();
  const zip  = $('#zip').value.trim();
  const road = $('#road').value.trim();
  const detail= $('#addrDetail').value.trim();
  const addr = [zip?`(${zip})`:'', road, detail].filter(Boolean).join(' ');
  const note = $('#recvNote').value.trim();
  const {p,q,r} = cur.price||{};
  const priceLine = [
    q!=null?`정가 ${fmtWon(q)}`:'', 
    p!=null?`판매가 ${fmtWon(p)}`:'', 
    (r!=null && !isNaN(r))?`할인율 ${r}%`:''
  ].filter(Boolean).join(' / ') || '가격 정보 없음';

  const method = $('#payMethod').value || '계좌이체';
  const t = calcTotals(cur.price||{}, qty, method);
  const shipText = (t.subtotal>=FREE_SHIP_THRESHOLD) ? '무료배송(40만원 이상)'
                  : (method==='계좌이체' ? `배송비 포함 ${fmtWon(t.shipFee)}` : '배송비 3,000원 추가 예정(카드)');
  const payLine = (method==='계좌이체')
    ? `결제방식: 계좌이체 (입금자: ${dep || '(입력)'} / 총 입금액: ${fmtWon(t.total)} / 계좌: 국민 616 701 01 634455 솔리드(한홍명))`
    : `결제방식: 카드결제 (예상 결제금액: ${fmtWon(t.subtotal)} / 배송비 별도 안내)`;

  return `[온라인 주문 요청]
상품코드: ${cur.style}
색상/사이즈: ${cur.color || '-'} / ${cur.size || '-'}
수량: ${qty}
가격: ${priceLine}
배송: ${shipText}

${payLine}

[수령자 정보]
이름: ${name}
연락처: ${phone}
주소: ${addr}
요청사항: ${note}

• 택배비: 40만원 이상 무료 / 그 이하 3,000원
• 교환: 수령 7일 내, 왕복 7,000원
* 재고 확인 후 안내 드리겠습니다.`;
}
function updatePreview(){ const el=$('#orderPreview'); if (el) el.textContent = buildOrderText(); }

async function sendOrder(){
  const method = $('#payMethod').value || '계좌이체';
  if (method==='계좌이체' && !$('#depositor').value.trim()){
    alert('입금자 성명을 입력해 주세요.'); $('#depositor').focus(); return;
  }
  if (!$('#recvName').value.trim()){ alert('수령자 이름을 입력해 주세요.'); $('#recvName').focus(); return; }
  if (!$('#recvPhone').value.trim()){ alert('연락처를 입력해 주세요.'); $('#recvPhone').focus(); return; }
  if (!$('#road').value.trim()){ alert('주소 검색 버튼으로 도로명 주소를 입력해 주세요.'); return; }

  const msg = buildOrderText();
  try{
    await navigator.clipboard.writeText(msg);
    alert('주문서 내용을 클립보드에 복사했어요.\n카카오 채널 대화창이 열리면 붙여넣기(길게 터치 → 붙여넣기) 해주세요.');
  }catch(e){
    alert('클립보드 복사가 안 되면, 주문 미리보기 내용을 길게 눌러 복사해 주세요.');
  }
  window.open(KAKAO_CHAT, '_blank');
  closeOrder();
  $('#pendingBack').style.display='flex';
}
function shareToKakao(){ window.open(KAKAO_CHAT, '_blank'); }
function closeOrder(){ $('#orderBack').style.display='none'; }
function closePending(){ $('#pendingBack').style.display='none'; }

/* ===== 검색 ===== */
function search(){
  const q = nz($('#q').value).toLowerCase();
  const rows = INV.filter(r=>{
    const code = nz(r['상품코드']).toLowerCase();
    const name = nz(r['품명']).toLowerCase();
    return q ? (code.includes(q) || name.includes(q)) : false;
  });
  render(rows);
}
$('#srchBtn').addEventListener('click', search);
$('#q').addEventListener('keydown', (e)=>{ if (e.key==='Enter') search(); });
$('#reloadBtn').addEventListener('click', ()=> loadInventory().then(()=> showStatus('새로고침 완료', true)) );

/* ===== 초기 로드 ===== */
(async function init(){
  await loadInventory();
})();
</script>
</body>
</html>
