<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì†”ë¦¬ë“œì˜´ë¯€ ì•„ìš¸ë › ì¬ê³  ì¡°íšŒ</title>
<link rel="manifest" href="manifest.webmanifest?v=12" />
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<style>
  :root { --bg:#0b0f14; --card:#121820; --muted:#94a3b8; --fg:#e8eef6; --accent:#5bbcff;
          --ok:#16a34a; --warn:#d97706; --bad:#ef4444; --incoming:#3b82f6; }
  html,body{margin:0;padding:0;background:#0b0f14;color:var(--fg);
            font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px;}
  h1{margin:0 0 16px 0;font-size:24px;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{background:#111827;border:1px solid #273547;color:#d9e7ff;padding:9px 12px;border-radius:12px;cursor:pointer}
  .btn.big{padding:10px 14px;font-weight:700}
  .btn.primary{background:#0f172a;border-color:#2b3a52}
  .btn.green{background:#0f2b1b;border-color:#1f5c37}
  .btn.blue{background:#0f1a3a;border-color:#3d4aac}
  .btn.ghost{background:transparent;border-color:#2b3a52}
  .search{
    width:100%;padding:12px 14px;border-radius:14px;border:1px solid #273547;
    background:#0f1620;color:var(--fg);
    caret-color:var(--fg);
    font-size:16px;
  }
  .search::placeholder{color:#9aa7b8}
  .card{background:linear-gradient(180deg,#121820,#0d1420);border:1px solid #1c2430;border-radius:16px;padding:16px;}
  .pill{border:1px solid #2a3950;background:#0f172a;color:#cfe8ff;border-radius:999px;padding:5px 9px;font-size:12px}
  .state{display:inline-block;border-radius:16px;padding:6px 12px;font-size:13px;border:1px solid transparent;
         cursor:pointer; background:#0f172a; color:#cfe8ff}
  .state.ok{background:#0f2b1b;border-color:#1f5c37;color:#b9f7d5}
  .state.warn{background:#2c1e0a;border-color:#7a4d17;color:#ffe4b5}
  .state.bad{background:#3a0f14;border-color:#7a1d22;color:#ffc9c9; cursor:default}
  .state.incoming{background:#0f1a3a;border-color:#3d4aac;color:#d2d8ff; cursor:default}
  .state:disabled{opacity:.6;cursor:not-allowed}
  .sizeCol{display:flex;flex-direction:column;gap:8px}
  .sizeItem{display:flex;align-items:center;gap:10px}
  .sizeTag{min-width:44px;text-align:center;border:1px solid #2a3950;border-radius:10px;padding:6px 8px;background:#0e1726;color:#cfe8ff;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 210px 1fr;gap:10px;align-items:center}
  .select{padding:9px 12px;border-radius:10px;border:1px solid #273547;background:#0e1622;color:var(--fg)}
  .price{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .price .now{font-weight:800;font-size:17px}
  .price .orig{color:#a8b5c6;text-decoration:line-through}
  .price .rate{color:#9fe4b0}
  .fitBox{margin-top:12px;border:1px dashed #2e3c52;border-radius:12px;padding:10px;background:#0f172a}
  .fitHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .fitList{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px}
  .fitItem{border:1px solid #273547;border-radius:10px;padding:8px;background:#0e1622;font-size:13px}
  .fitSmall{color:#9fb0c6;font-size:12px}
  .totalBox{margin-top:8px;border:1px dashed #2e3c52;border-radius:12px;padding:8px 10px;background:#0f172a}
  .totalBox .line{display:flex;justify-content:space-between;margin:2px 0}
  .totalBox .sum{font-weight:800}
  .hint{font-size:12px;color:#a5b4c6}
  footer{margin:24px 0;color:#9aa7b8;font-size:13px;display:flex;gap:14px;flex-wrap:wrap;justify-content:flex-end}
  .hero{position:fixed;inset:0;z-index:-1;background:url('031.jpg') center/cover no-repeat;filter:brightness(.35)}
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999;padding:10px}
  .modal{width:min(560px,94vw);max-height:88vh;display:flex;flex-direction:column;background:#101622;border:1px solid #1e2a3a;border-radius:16px;}
  .modalHeader{padding:14px 16px;border-bottom:1px solid #1c2430;display:flex;align-items:center;justify-content:space-between}
  .modalBody{padding:14px 16px;overflow:auto}
  .modalFooter{padding:12px 16px;border-top:1px solid #1c2430;display:flex;justify-content:flex-end;gap:8px}
  .muted{color:#a1a8b5}
  .copy{border:1px dashed #2e3c52;border-radius:10px;padding:8px 10px;background:#0f172a}
  .note{background:#0e1522;border:1px solid #203047;border-radius:12px;padding:10px}
  .small{font-size:12px;color:#9fb0c6}
  input.txt, textarea.txt, select.sel{width:100%;padding:9px 11px;border-radius:10px;border:1px solid #2a3950;background:#0f172a;color:#e7f0ff;font-size:14px}
  textarea.txt{min-height:64px;resize:vertical}
  .label{font-size:12px;color:#9fb0c6;margin:6px 0 4px}
  .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .buttonRow{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:520px){ .grid{grid-template-columns:1fr;gap:8px} }
</style>
</head>
<body>
<div class="hero"></div>
<div class="wrap">
  <div class="row" style="justify-content:flex-end;gap:8px;margin-bottom:6px">
    <a class="btn" href="tel:0221369886">ğŸ“ ë§¤ì¥ ì „í™”</a>
    <a class="btn" href="https://pf.kakao.com/_EfjEj" target="_blank" rel="noopener">ğŸ’¬ ì¹´ì¹´ì˜¤ ì±„ë„</a>
  </div>

  <h1>ì†”ë¦¬ë“œì˜´ë¯€ ì•„ìš¸ë › ì¬ê³  ì¡°íšŒ</h1>

  <div class="card" style="margin-bottom:12px">
    <div class="row" style="gap:8px">
      <input id="q" class="search" placeholder="ì˜ˆ: s243ts26â€¦" />
      <button class="btn" id="srchBtn">ğŸ” ê²€ìƒ‰</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0">ì¬ê³  ê²°ê³¼</h3>
    <div id="result"></div>
  </div>

  <footer>
    <a href="about.html">ë¸Œëœë“œ ì†Œê°œ</a>
    <a href="privacy.html">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
    <a href="guide.html">ì£¼ë¬¸Â·ë°°ì†¡Â·êµí™˜ ì•ˆë‚´</a>
  </footer>
</div>

<!-- ì£¼ë¬¸ ëª¨ë‹¬ -->
<div id="orderBack" class="modalBack" onclick="closeOrder(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3 style="margin:0;font-size:18px">ì£¼ë¬¸ì„œ ì‘ì„±</h3>
      <button class="btn ghost" type="button" onclick="closeOrder()">ë‹«ê¸°</button>
    </div>

    <div class="modalBody">
      <div id="orderSel" class="muted" style="margin-bottom:8px"></div>

      <div class="note small" style="margin:6px 0 10px 0">
        <div>â€¢ <b>íƒë°°ë¹„</b> : <b>40ë§Œì› ì´ìƒ ë¬´ë£Œ</b> / ê·¸ ì´í•˜ëŠ” <b>3,000ì›</b></div>
        <div>â€¢ <b>êµí™˜/ë°˜í’ˆ</b> : ìˆ˜ë ¹ í›„ 7ì¼ ì´ë‚´ (ì™•ë³µ <b>7,000ì›</b>)</div>
        <div>â€¢ ì˜¤í”„ë¼ì¸ ì¬ê³  ì—°ë™ì´ë¼ ê²°ì œ í›„ í’ˆì ˆ ì‹œ <b>ì „ì•¡ í™˜ë¶ˆ</b>ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="buttonRow" style="margin-bottom:6px">
        <button class="btn big green" type="button" onclick="choosePay('ê³„ì¢Œì´ì²´')">ê³„ì¢Œì´ì²´ë¡œ ì£¼ë¬¸</button>
        <button class="btn big blue"  type="button" onclick="choosePay('ì¹´ë“œê²°ì œ')">ì¹´ë“œê²°ì œë¡œ ì£¼ë¬¸</button>
      </div>

      <div class="formGrid" style="margin:6px 0 6px 0">
        <div>
          <div class="label">ì„ íƒëœ ê²°ì œ ë°©ì‹</div>
          <input id="payMethod" class="txt" value="ê³„ì¢Œì´ì²´" readonly />
        </div>
        <div>
          <div class="label">ìˆ˜ëŸ‰</div>
          <input id="qty" type="number" class="txt" min="1" step="1" value="1" />
        </div>
      </div>

      <div id="depositorBox">
        <div class="label">ì…ê¸ˆì ì„±ëª… (ê³„ì¢Œì´ì²´)</div>
        <input id="depositor" class="txt" placeholder="ì˜ˆ: í™ê¸¸ë™" />
      </div>

      <!-- ì²´í˜•/ì°©ìš© ì •ë³´ ìˆ˜ì§‘ -->
      <div class="formGrid" style="margin-top:8px">
        <div>
          <div class="label">í‚¤ (cm) â€” ê³µê°œ ë™ì˜ì‹œ ë‹¤ë¥¸ ê³ ê°ì—ê²Œ ë„ì›€ë©ë‹ˆë‹¤</div>
          <input id="height" class="txt" placeholder="ì˜ˆ: 178" inputmode="numeric" />
        </div>
        <div>
          <div class="label">ëª¸ë¬´ê²Œ (kg)</div>
          <input id="weight" class="txt" placeholder="ì˜ˆ: 72" inputmode="numeric" />
        </div>
      </div>
      <label class="small" style="display:flex;gap:6px;align-items:center;margin-top:6px">
        <input id="shareFit" type="checkbox" />
        ì£¼ë¬¸í•œ <b>ìŠ¤íƒ€ì¼/ì»¬ëŸ¬/ì‚¬ì´ì¦ˆ + í‚¤/ëª¸ë¬´ê²Œ</b>ë¥¼ ìµëª…ìœ¼ë¡œ ê³µê°œí•˜ì—¬ ë‹¤ìŒ ê³ ê°ì—ê²Œ ë„ì›€ ì£¼ê¸° (ì„ íƒ)
      </label>

      <!-- ê¸ˆì•¡ ìš”ì•½ -->
      <div id="totalBox" class="totalBox" style="margin-top:8px">
        <div class="line"><span>ë‹¨ê°€</span><span id="unitPrice">-</span></div>
        <div class="line"><span>ìˆ˜ëŸ‰</span><span id="qtyView">1</span></div>
        <div class="line"><span>ì†Œê³„</span><span id="subtotalView">-</span></div>
        <div class="line"><span>ë°°ì†¡ë¹„</span><span id="shipView">-</span></div>
        <div class="line sum"><span id="totalLabel">ê²°ì œê¸ˆì•¡</span><span id="totalView">-</span></div>
        <div class="hint" id="shipHint" style="margin-top:4px"></div>
      </div>

      <div class="formGrid" style="margin-top:8px">
        <div>
          <div class="label">ìˆ˜ë ¹ì ì´ë¦„</div>
          <input id="recvName" class="txt" placeholder="ì˜ˆ: ê¹€ì†”ë¦¬ë“œ" />
        </div>
        <div>
          <div class="label">ì—°ë½ì²˜</div>
          <input id="recvPhone" class="txt" placeholder="ì˜ˆ: 010-1234-5678" />
        </div>
      </div>

      <div class="label" style="margin-top:6px">ì£¼ì†Œ</div>
      <div class="row" style="gap:6px;margin-bottom:6px">
        <input id="zip" class="txt" placeholder="ìš°í¸ë²ˆí˜¸" style="max-width:140px" readonly />
        <button class="btn" type="button" onclick="findAddr()">ì£¼ì†Œ ê²€ìƒ‰</button>
      </div>
      <input id="road" class="txt" placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly style="margin-bottom:6px" />
      <input id="addrDetail" class="txt" placeholder="ìƒì„¸ ì£¼ì†Œ (ë™/í˜¸ìˆ˜ ë“±)" />

      <div class="label" style="margin-top:6px">ìš”ì²­ì‚¬í•­</div>
      <textarea id="recvNote" class="txt" placeholder="ë°°ì†¡ ê´€ë ¨ ë©”ëª¨"></textarea>

      <div class="copy" style="margin-top:8px">
        <div><b>ì£¼ë¬¸ ë¯¸ë¦¬ë³´ê¸°</b> (ì¹´ì¹´ì˜¤ ì±„ë„ë¡œ ì „ì†¡ë©ë‹ˆë‹¤)</div>
        <pre id="orderPreview" style="white-space:pre-wrap;margin:6px 0 0 0"></pre>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn primary" type="button" onclick="sendOrder()">ì£¼ë¬¸ ë³´ë‚´ê¸°</button>
    </div>
  </div>
</div>

<!-- ì£¼ë¬¸ í™•ì¸ì¤‘ ëª¨ë‹¬ -->
<div id="pendingBack" class="modalBack" onclick="closePending(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <h3 style="margin:0;font-size:18px">ì£¼ë¬¸ í™•ì¸ì¤‘</h3>
      <button class="btn ghost" type="button" onclick="closePending()">í™•ì¸</button>
    </div>
    <div class="modalBody">
      <div class="muted" style="white-space:pre-wrap">
ì˜ì—…ì‹œê°„ 10:30~21:00 ì‹¤ì‹œê°„ ë§¤ì¥í™•ì¸ ì—°ë½ë“œë¦¬ë©°
ì˜ì—…ì‹œê°„ ì´í›„ 21:00~ ë‹¤ìŒë‚  ë§¤ì¥ ì˜¤í”ˆ ì´í›„ ìˆœì°¨ì ìœ¼ë¡œ ì—°ë½ë“œë¦½ë‹ˆë‹¤.
ê²°ì œ/ì´ì²´ í™•ì¸ í›„ ìˆœì°¨ì ìœ¼ë¡œ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì¹´ì¹´ì˜¤ ì±„ë„ ì•Œë¦¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.

íƒë°°ë¹„ ì•ˆë‚´ 40ë§Œì› ì´ìƒ êµ¬ë§¤ì‹œ ë¬´ë£Œë°°ì†¡ / ê·¸ ì´í•˜ 3,000ì› 
ë‹¨ìˆœ ë³€ì‹¬ êµí™˜ ì™•ë³µ íƒë°°ë¹„ 7,000ì›
êµ­ë¯¼ 616 701 01 634455 ì†”ë¦¬ë“œ(í•œí™ëª…)

ì œí’ˆ ìˆ˜ë ¹ í›„ êµí™˜ì€ 1ì£¼ì¼ ì´ë‚´ë¡œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

<script>
/* ===== ì„¤ì • ===== */
const INV_URL = `inventory.json?v=${Date.now()}`;
const KAKAO_CHAT = 'https://pf.kakao.com/_EfjEj/chat';
const FREE_SHIP_THRESHOLD = 400000;
const SHIP_FEE = 3000;
/* Google Apps Script(Web App) URL */
const FIT_API = 'https://script.google.com/macros/s/AKfycbxiEClhSskp-Cz4ufqv7pr_1TUeRLfPPp0sWUX0t01obnQ7ISUTPwVSxyerx3PrXwPd/exec';

/* ===== ìœ í‹¸ ===== */
const $  = s => document.querySelector(s);
const nz = v => (v==null ? '' : String(v).trim());
function toInt(v, d=0){ try{ const s=String(v??'').replace(/[^\d-]/g,'').trim(); if(!s||s==='-')return d; return parseInt(s,10);}catch{return d;} }
function fmtWon(v){ return (v==null||v==='') ? '-' : Number(v).toLocaleString()+'ì›'; }

/* ìƒíƒœ ê·œì¹™ */
function decideState(store, wh, total){
  const s = toInt(store, 0);
  const w = toInt(wh, 0);
  const t = (total!=null) ? toInt(total, s+w) : (s+w);

  if (t <= 0) return {label:'ì£¼ë¬¸ë¶ˆê°€', cls:'bad',  clickable:false};
  if (t < 9)  return {label:'í’ˆì ˆì„ë°•', cls:'warn', clickable:true};
  if (s === 0 && w > 0) return {label:'í’ˆì ˆì„ë°•', cls:'warn', clickable:true};
  return {label:'ì£¼ë¬¸ê°€ëŠ¥', cls:'ok', clickable:true};
}

/* ë°ì´í„° ì •ê·œí™” */
function normalizeRow(r){
  const out = {...r};
  if (out['ë§¤ì¥ì¬ê³ ']==null && out['ë§¤ì¥í•©']!=null) out['ë§¤ì¥ì¬ê³ ']=out['ë§¤ì¥í•©'];
  if (out['ì°½ê³ ì¬ê³ ']==null && out['ë¬¼ë¥˜í•©']!=null) out['ì°½ê³ ì¬ê³ ']=out['ë¬¼ë¥˜í•©'];
  if (out['ì „ì²´ì¬ê³ ']==null && out['ì „ì²´í•©']!=null) out['ì „ì²´ì¬ê³ ']=out['ì „ì²´í•©'];
  if (out['ì†Œë¹„ìê°€']==null && out['í• ì¸ì „ê°€ê²©']!=null) out['ì†Œë¹„ìê°€']=out['í• ì¸ì „ê°€ê²©'];
  if (out['í• ì¸ìœ¨']==null && out['í• ì¸ìœ¨(%)']!=null) out['í• ì¸ìœ¨']=out['í• ì¸ìœ¨(%)'];
  return out;
}
let INV=[];
async function load(){
  const res = await fetch(INV_URL, {cache:'no-store'});
  INV = (await res.json()).map(normalizeRow);
}

/* ê·¸ë£¹í™”/ì •ë ¬ */
function groupByStyle(rows){
  const map = new Map();
  for (const r of rows){
    const code = nz(r['ìƒí’ˆì½”ë“œ']).toUpperCase();
    const color = nz(r['ìƒ‰ìƒ']);
    const size  = nz(r['ì‚¬ì´ì¦ˆ']);
    if (!map.has(code)) map.set(code, {code, colors:new Map()});
    const entry = map.get(code);
    if (!entry.colors.has(color)) entry.colors.set(color, []);
    entry.colors.get(color).push(r);
  }
  const orderRTW=['44','46','48','50','52','54'];
  const orderP  =['28','30','31','32','33','34','36'];
  const orderS  =['39','40','41','42','43'];
  const idx=(s)=> orderRTW.includes(s)?orderRTW.indexOf(s):orderP.includes(s)?100+orderP.indexOf(s):orderS.includes(s)?200+orderS.indexOf(s):999;
  for (const [,v] of map){ for (const [c,arr] of v.colors){ arr.sort((a,b)=>idx(nz(a['ì‚¬ì´ì¦ˆ']))-idx(nz(b['ì‚¬ì´ì¦ˆ']))); v.colors.set(c,arr);} }
  return map;
}
function computePrice(rows){
  const r0 = rows.find(r=> r['íŒë§¤ê°€']!=null || r['ì†Œë¹„ìê°€']!=null || r['í• ì¸ìœ¨']!=null) || {};
  let p = toInt(r0['íŒë§¤ê°€'], null);
  let q = toInt(r0['ì†Œë¹„ìê°€'], null);
  let r = r0['í• ì¸ìœ¨']!=null ? Number(r0['í• ì¸ìœ¨']) : null;
  if ((r==null || Number.isNaN(r)) && p!=null && q!=null && q>0) r = Math.round((1 - p/q) * 1000)/10;
  if ((q==null || q===0) && p!=null && r!=null) q = Math.round(p / (1 - r/100));
  return {p,q,r};
}
function priceHTML(rows){
  const {p,q,r} = computePrice(rows);
  if (p==null && q==null) return `<div class="pill">ê°€ê²© ì •ë³´ ì—†ìŒ</div>`;
  const a=[];
  if (q!=null) a.push(`<span class="orig">ì •ê°€ ${fmtWon(q)}</span>`);
  if (p!=null) a.push(`<span class="now">íŒë§¤ê°€ ${fmtWon(p)}</span>`);
  if (r!=null) a.push(`<span class="rate">(-${r}%)</span>`);
  return `<div class="price">${a.join(' ')}</div>`;
}

/* ê²°ì œ í•©ê³„ */
function calcTotals(price, qty, pay){
  const unit = (price.p!=null ? price.p : price.q);
  const unitSafe = (unit==null ? 0 : unit);
  const subtotal = unitSafe * qty;

  let shipFee = 0;
  let total = subtotal;
  let hint = '';

  if (subtotal >= FREE_SHIP_THRESHOLD){
    hint = '40ë§Œì› ì´ìƒ êµ¬ë§¤ë¡œ ë¬´ë£Œë°°ì†¡ì…ë‹ˆë‹¤.';
  }else{
    if (pay === 'ê³„ì¢Œì´ì²´'){
      shipFee = SHIP_FEE;
      total = subtotal + shipFee;
      hint = 'ê³„ì¢Œì´ì²´: 40ë§Œì› ë¯¸ë§Œì€ ë°°ì†¡ë¹„ 3,000ì›ì´ ì´ì•¡ì— í¬í•¨ë©ë‹ˆë‹¤.';
    }else{
      hint = 'ì¹´ë“œê²°ì œ: 40ë§Œì› ë¯¸ë§Œì€ ë°°ì†¡ë¹„ 3,000ì›ì´ ì¶”ê°€ë©ë‹ˆë‹¤(ê²°ì œ ì•ˆë‚´ ì‹œ ê³ ì§€).';
    }
  }
  return { unit, subtotal, shipFee, total, hint };
}

/* ë Œë” */
function render(list){
  if (!list.length){ $('#result').innerHTML = `<div style="color:#9aa7b8">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
  const g = groupByStyle(list);
  const blocks=[];
  for (const [, item] of g){
    const colors = Array.from(item.colors.keys());
    const colorSelId = 'color_'+Math.random().toString(36).slice(2,8);
    const firstColor = colors[0] || '(ìƒ‰ìƒì—†ìŒ)';
    const firstRows  = item.colors.get(firstColor) || [];
    const head = `
      <div class="grid" style="margin:6px 0 8px 0">
        <div><div class="pill" style="font-weight:700;font-size:16px">${item.code}</div></div>
        <div>
          <select id="${colorSelId}" class="select">
            ${colors.map(c=>`<option value="${c}">${c || '(ìƒ‰ìƒì—†ìŒ)'}</option>`).join('')}
          </select>
        </div>
        <div id="${colorSelId}_price">${priceHTML(firstRows)}</div>
      </div>
      <div id="${colorSelId}_sizes" class="sizeCol"></div>
      <div id="${colorSelId}_fit" class="fitBox">
        <div class="fitHead">
          <div><b>êµ¬ë§¤ì ì²´í˜•/ì°©ìš©ì‚¬ì´ì¦ˆ í›„ê¸°</b> <span class="fitSmall">(ìµëª…, ìµœê·¼ 10ê±´)</span></div>
          <button class="btn ghost" type="button" onclick="reloadFit('${item.code}','${firstColor}','${colorSelId}')">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="fitList" id="${colorSelId}_fitList"></div>
      </div>
    `;
    blocks.push(`<div style="border-top:1px solid #1c2430;padding-top:10px;margin-top:10px">${head}</div>`);
    setTimeout(()=> {
      updateSizes(colorSelId, item, firstColor);
      const sel = document.getElementById(colorSelId);
      sel?.addEventListener('change', (e)=>{
        const c = e.target.value;
        updateSizes(colorSelId, item, c);
        document.getElementById(colorSelId+'_price').innerHTML = priceHTML(item.colors.get(c)||[]);
        reloadFit(item.code, c, colorSelId);
      });
      reloadFit(item.code, firstColor, colorSelId);
    }, 0);
  }
  $('#result').innerHTML = blocks.join('');
}

/* === [í•µì‹¬ ìˆ˜ì •] ì‚¬ì´ì¦ˆ ë‹¨ìœ„ â€˜í•©ì‚° ì§‘ê³„â€™ í›„ ìƒíƒœ ê³„ì‚° === */
function aggregateBySize(rows){
  const map = new Map();
  for (const r of rows){
    const size = nz(r['ì‚¬ì´ì¦ˆ']);
    if (!map.has(size)) map.set(size, {ë§¤ì¥:0, ì°½ê³ :0, ì´:0});
    const t = map.get(size);
    t.ë§¤ì¥ += toInt(r['ë§¤ì¥ì¬ê³ '], 0);
    t.ì°½ê³  += toInt(r['ì°½ê³ ì¬ê³ '], 0);
    const tot = (r['ì „ì²´ì¬ê³ ']!=null) ? toInt(r['ì „ì²´ì¬ê³ '], 0) : (toInt(r['ë§¤ì¥ì¬ê³ '],0)+toInt(r['ì°½ê³ ì¬ê³ '],0));
    t.ì´   += tot; // ë™ì¼ ì‚¬ì´ì¦ˆ ì¤‘ë³µ ë¼ì¸ì´ë©´ ì´í•©
  }
  return map; // key: ì‚¬ì´ì¦ˆ, val: {ë§¤ì¥,ì°½ê³ ,ì´}
}

function updateSizes(id, item, color){
  const box = document.getElementById(id+'_sizes');
  const rows = item.colors.get(color)||[];
  if (!rows.length){
    box.innerHTML = `<div class="sizeItem"><span class="sizeTag">-</span><span class="state bad">ì£¼ë¬¸ë¶ˆê°€</span></div>`;
    return;
  }

  // ì‚¬ì´ì¦ˆë³„ í•©ì‚°
  const agg = aggregateBySize(rows);
  const price = computePrice(rows); // í•œ ìƒ‰ìƒ ê°€ê²© ëŒ€í‘œê°’

  // ì •ë ¬ í‚¤ ì¬ì‚¬ìš©
  const orderRTW=['44','46','48','50','52','54'];
  const orderP  =['28','30','31','32','33','34','36'];
  const orderS  =['39','40','41','42','43'];
  const idx=(s)=> orderRTW.includes(s)?orderRTW.indexOf(s):orderP.includes(s)?100+orderP.indexOf(s):orderS.includes(s)?200+orderS.indexOf(s):999;

  const entries = Array.from(agg.entries()).sort((a,b)=> idx(a[0]) - idx(b[0]));
  const html = entries.map(([size, val])=>{
    const st = decideState(val.ë§¤ì¥, val.ì°½ê³ , val.ì´);
    const attrs = `data-style="${item.code}" data-color="${color}" data-size="${size}" data-price='${JSON.stringify(price)}'`;
    const clickable = st.clickable ? `onclick="openOrderDirect(this)" role="button" tabindex="0"` : 'aria-disabled="true"';
    return `<div class="sizeItem">
              <span class="sizeTag">${size}</span>
              <span class="state ${st.cls}" ${attrs} ${clickable}>${st.label}</span>
            </div>`;
  }).join('');
  box.innerHTML = html;
}

/* í›„ê¸° ë¶ˆëŸ¬ì˜¤ê¸°/ê·¸ë¦¬ê¸° */
async function reloadFit(style,color,baseId){
  const host = document.getElementById(baseId+'_fitList');
  if(!host) return;
  try{
    const url = `${FIT_API}?style=${encodeURIComponent(style)}&color=${encodeURIComponent(color)}`;
    const res = await fetch(url, {cache:'no-store'});
    const data = await res.json();
    const list = (data.list||[]).slice(-10).reverse();
    if(!list.length){
      host.innerHTML = `<div class="fitSmall">ì•„ì§ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</div>`;
      return;
    }
    host.innerHTML = list.map(x=>`
      <div class="fitItem">
        <div><b>${x.size}</b> ì°©ìš©</div>
        <div class="fitSmall">${x.height_cm?`${x.height_cm}cm`:''} ${x.weight_kg?`${x.weight_kg}kg`:''}</div>
        <div class="fitSmall">${new Date(x.timestamp).toLocaleDateString()}</div>
      </div>
    `).join('');
  }catch(e){
    host.innerHTML = `<div class="fitSmall">í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
  }
}

/* ì£¼ì†Œê²€ìƒ‰ */
function findAddr(){
  new daum.Postcode({
    oncomplete: function(d) {
      $('#zip').value  = d.zonecode || '';
      $('#road').value = d.roadAddress || d.address || '';
      $('#addrDetail').focus();
      updatePreview();
    }
  }).open();
}

/* ì£¼ë¬¸ íë¦„ */
let cur = {style:'', color:'', size:'', price:{p:null,q:null,r:null}, pay:'ê³„ì¢Œì´ì²´'};
function openOrderDirect(el){
  cur.style = el.getAttribute('data-style');
  cur.color = el.getAttribute('data-color');
  cur.size  = el.getAttribute('data-size');
  try { cur.price = JSON.parse(el.getAttribute('data-price')||'{}'); } catch { cur.price={}; }
  cur.pay = 'ê³„ì¢Œì´ì²´';
  const {p,q,r} = cur.price||{};
  const priceLine = [
    q!=null?`ì •ê°€ ${fmtWon(q)}`:'', 
    p!=null?`íŒë§¤ê°€ ${fmtWon(p)}`:'', 
    (r!=null && !isNaN(r))?`í• ì¸ìœ¨ ${r}%`:''
  ].filter(Boolean).join(' Â· ') || 'ê°€ê²© ì •ë³´ ì—†ìŒ';

  $('#orderSel').textContent = `ì„ íƒ: ${cur.style} ${cur.color || ''} ${cur.size || ''}  |  ${priceLine}`;
  $('#qty').value = 1;
  $('#payMethod').value = cur.pay;
  $('#depositor').value = '';
  $('#recvName').value = '';
  $('#recvPhone').value = '';
  $('#zip').value = '';
  $('#road').value = '';
  $('#addrDetail').value = '';
  $('#recvNote').value = '';
  $('#height').value = '';
  $('#weight').value = '';
  $('#shareFit').checked = false;
  showDepositor(true);
  renderTotals();
  updatePreview();
  $('#orderBack').style.display='flex';
}
function closeOrder(){ $('#orderBack').style.display='none'; }

/* ì£¼ë¬¸ í™•ì¸ì¤‘ ëª¨ë‹¬ ë‹«ê¸° */
function closePending(){
  const back = document.getElementById('pendingBack');
  if (back) back.style.display = 'none';
}

function choosePay(kind){
  cur.pay = kind;
  $('#payMethod').value = kind;
  showDepositor(kind==='ê³„ì¢Œì´ì²´');
  renderTotals();
  updatePreview();
}
function showDepositor(show){
  $('#depositorBox').style.display = show ? 'block' : 'none';
}

['qty','depositor','recvName','recvPhone','addrDetail','recvNote','height','weight'].forEach(id=>{
  document.addEventListener('input', (e)=>{ if (e.target && e.target.id===id) { renderTotals(); updatePreview(); } });
  document.addEventListener('change', (e)=>{ if (e.target && e.target.id===id) { renderTotals(); updatePreview(); } });
});

/* í•©ê³„/ë¯¸ë¦¬ë³´ê¸° */
function renderTotals(){
  const qty = Math.max(1, parseInt($('#qty').value||'1',10));
  const method = $('#payMethod').value || 'ê³„ì¢Œì´ì²´';
  const t = calcTotals(cur.price||{}, qty, method);
  $('#unitPrice').textContent   = fmtWon(t.unit);
  $('#qtyView').textContent     = String(qty);
  $('#subtotalView').textContent= fmtWon(t.subtotal);
  $('#shipView').textContent    = (method==='ê³„ì¢Œì´ì²´' || t.subtotal>=FREE_SHIP_THRESHOLD) ? fmtWon(t.shipFee) : 'ì¶”ê°€ ì˜ˆì •';
  $('#totalLabel').textContent  = (method==='ê³„ì¢Œì´ì²´' ? 'ê²°ì œê¸ˆì•¡(ê³„ì¢Œì´ì²´)' : 'ê²°ì œê¸ˆì•¡(ì˜ˆìƒ)');
  $('#totalView').textContent   = (method==='ê³„ì¢Œì´ì²´' ? fmtWon(t.total) : fmtWon(t.subtotal));
  $('#shipHint').textContent    = t.hint;
}
function buildOrderText(){
  const qty  = Math.max(1, parseInt($('#qty').value||'1',10));
  const dep  = $('#depositor').value.trim();
  const name = $('#recvName').value.trim();
  const phone= $('#recvPhone').value.trim();
  const zip  = $('#zip').value.trim();
  const road = $('#road').value.trim();
  const detail= $('#addrDetail').value.trim();
  const addr = [zip?`(${zip})`:'', road, detail].filter(Boolean).join(' ');
  const note = $('#recvNote').value.trim();
  const height = $('#height').value.trim();
  const weight = $('#weight').value.trim();
  const {p,q,r} = cur.price||{};
  const priceLine = [
    q!=null?`ì •ê°€ ${fmtWon(q)}`:'', 
    p!=null?`íŒë§¤ê°€ ${fmtWon(p)}`:'', 
    (r!=null && !isNaN(r))?`í• ì¸ìœ¨ ${r}%`:''
  ].filter(Boolean).join(' / ') || 'ê°€ê²© ì •ë³´ ì—†ìŒ';

  const method = $('#payMethod').value || 'ê³„ì¢Œì´ì²´';
  const totals = calcTotals(cur.price||{}, qty, method);

  const shipText = (totals.subtotal>=FREE_SHIP_THRESHOLD)
    ? 'ë¬´ë£Œë°°ì†¡(40ë§Œì› ì´ìƒ)'
    : (method==='ê³„ì¢Œì´ì²´' ? `ë°°ì†¡ë¹„ í¬í•¨ ${fmtWon(totals.shipFee)}` : 'ë°°ì†¡ë¹„ 3,000ì› ì¶”ê°€ ì˜ˆì •(ì¹´ë“œ)');

  const payLine = (method==='ê³„ì¢Œì´ì²´')
    ? `ê²°ì œë°©ì‹: ê³„ì¢Œì´ì²´ (ì…ê¸ˆì: ${dep || '(ì…ë ¥)'} / ì´ ì…ê¸ˆì•¡: ${fmtWon(totals.total)} / ê³„ì¢Œ: êµ­ë¯¼ 616 701 01 634455 ì†”ë¦¬ë“œ(í•œí™ëª…))`
    : `ê²°ì œë°©ì‹: ì¹´ë“œê²°ì œ (ì˜ˆìƒ ê²°ì œê¸ˆì•¡: ${fmtWon(totals.subtotal)} / ë°°ì†¡ë¹„ ë³„ë„ ì•ˆë‚´)`;

  return (
`[ì˜¨ë¼ì¸ ì£¼ë¬¸ ìš”ì²­]
ìƒí’ˆì½”ë“œ: ${cur.style}
ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ: ${cur.color || '-'} / ${cur.size || '-'}
ìˆ˜ëŸ‰: ${qty}
ê°€ê²©: ${priceLine}
ì²´í˜•: ${height?height+'cm':''} ${weight?weight+'kg':''}
ë°°ì†¡: ${shipText}

${payLine}

[ìˆ˜ë ¹ì ì •ë³´]
ì´ë¦„: ${name}
ì—°ë½ì²˜: ${phone}
ì£¼ì†Œ: ${addr}
ìš”ì²­ì‚¬í•­: ${note}

â€¢ íƒë°°ë¹„: 40ë§Œì› ì´ìƒ ë¬´ë£Œ / ê·¸ ì´í•˜ 3,000ì›
â€¢ êµí™˜: ìˆ˜ë ¹ 7ì¼ ë‚´, ì™•ë³µ 7,000ì›
* ì¬ê³  í™•ì¸ í›„ ì•ˆë‚´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.` );
}
function updatePreview(){ $('#orderPreview').textContent = buildOrderText(); }

/* ì¹´ì¹´ì˜¤ ì „ì†¡ + í›„ê¸° ê¸°ë¡ */
async function sendOrder(){
  if (cur.pay==='ê³„ì¢Œì´ì²´' && !$('#depositor').value.trim()){
    alert('ì…ê¸ˆì ì„±ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); $('#depositor').focus(); return;
  }
  if (!$('#recvName').value.trim()){ alert('ìˆ˜ë ¹ì ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); $('#recvName').focus(); return; }
  if (!$('#recvPhone').value.trim()){ alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); $('#recvPhone').focus(); return; }
  if (!$('#road').value.trim()){ alert('ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ìœ¼ë¡œ ë„ë¡œëª… ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

  const msg = buildOrderText();

  try{ await navigator.clipboard.writeText(msg); }catch{}

  if ($('#shareFit').checked && FIT_API && FIT_API.startsWith('http')){
    const params = new URLSearchParams({
      style: cur.style,
      color: cur.color,
      size:  cur.size,
      height_cm: ($('#height').value||'').trim(),
      weight_kg: ($('#weight').value||'').trim()
    });
    try{
      await fetch(FIT_API, {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body: params.toString()
      });
    }catch(e){}
  }

  window.open(KAKAO_CHAT, '_blank');
  alert('ì£¼ë¬¸ ë‚´ìš©ì´ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¹´ì¹´ì˜¤ ì±„ë„ ëŒ€í™”ì°½ì´ ì—´ë¦¬ë©´ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.');
  closeOrder();
  document.getElementById('pendingBack').style.display='flex';
}

/* ê²€ìƒ‰ */
function search(){
  const q = nz($('#q').value).toLowerCase();
  const rows = INV.filter(r=>{
    const code = nz(r['ìƒí’ˆì½”ë“œ']).toLowerCase();
    const name = nz(r['í’ˆëª…']).toLowerCase();
    return q ? (code.includes(q) || name.includes(q)) : false;
  });
  render(rows);
}
$('#srchBtn').addEventListener('click', search);
$('#q').addEventListener('keydown', (e)=>{ if (e.key==='Enter') search(); });

/* ì´ˆê¸° ë¡œë“œ */
load().catch(()=>{});
</script>
</body>
</html>
